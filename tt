apiVersion: kyverno.io/v2
kind: ClusterPolicy
metadata:
  name: enforce-whitelisted-images
spec:
  validationFailureAction: Enforce
  failurePolicy: Ignore
  background: false

  rules:
    - name: whitelist-images
      match:
        resources:
          kinds:
            - Pod
      context:
        - name: allowedRegistries
          configMap:
            name: allowed-registries
            namespace: kyverno
      validate:
        message: "Container image is not from a whitelisted registry or organization."

        foreach:
          - list: "images.containers"
            preconditions:
              any:
                # Skip internal images
                - key: "{{ element.registry }}"
                  operator: Equals
                  value: "registry.mycorp.io"
            deny:
              conditions:
                all:
                  # Deny if registry is not in whitelist
                  - key: "{{ element.registry }}"
                    operator: NotIn
                    value: "{{ parse_yaml(allowedRegistries.data.registries) | keys }}"

                  # Deny if org is not allowed for the registry
                  - key: "{{ element.repository.split('/')[0] || 'library' }}"
                    operator: NotIn
                    value: "{{ parse_yaml(allowedRegistries.data.registries)[element.registry || 'docker.io'] }}"

          # Repeat for initContainers
          - list: "images.initContainers"
            preconditions:
              any:
                - key: "{{ element.registry }}"
                  operator: Equals
                  value: "registry.mycorp.io"
            deny:
              conditions:
                all:
                  - key: "{{ element.registry }}"
                    operator: NotIn
                    value: "{{ parse_yaml(allowedRegistries.data.registries) | keys }}"
                  - key: "{{ element.repository.split('/')[0] || 'library' }}"
                    operator: NotIn
                    value: "{{ parse_yaml(allowedRegistries.data.registries)[element.registry || 'docker.io'] }}"

          # Repeat for ephemeralContainers
          - list: "images.ephemeralContainers"
            preconditions:
              any:
                - key: "{{ element.registry }}"
                  operator: Equals
                  value: "registry.mycorp.io"
            deny:
              conditions:
                all:
                  - key: "{{ element.registry }}"
                    operator: NotIn
                    value: "{{ parse_yaml(allowedRegistries.data.registries) | keys }}"
                  - key: "{{ element.repository.split('/')[0] || 'library' }}"
                    operator: NotIn
                    value: "{{ parse_yaml(allowedRegistries.data.registries)[element.registry || 'docker.io'] }}"
